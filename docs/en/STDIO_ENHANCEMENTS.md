# NexaOS nrlib stdio å¢å¼ºå®ç°æ€»ç»“

## æ”¹è¿›æ¦‚è¿°

æˆåŠŸå°† `userspace/nrlib/src/stdio.rs` ä»ç®€å•çš„æ— ç¼“å†²å®ç°å‡çº§ä¸ºåŠŸèƒ½å®Œæ•´çš„ã€ç±»ä¼¼ libc çš„ç¼“å†² I/O åº“ã€‚

## ä¸»è¦æ”¹è¿›

### 1. **ç¼“å†² I/O å®ç°** âœ…
- **FILE ç»“æ„å¢å¼º**ï¼š
  - 512 å­—èŠ‚è¯»/å†™ç¼“å†²åŒº
  - ç¼“å†²æ¨¡å¼æ”¯æŒï¼š`Unbuffered`ï¼ˆæ— ç¼“å†²ï¼‰ã€`Line`ï¼ˆè¡Œç¼“å†²ï¼‰ã€`Full`ï¼ˆå…¨ç¼“å†²ï¼‰
  - é”™è¯¯å’Œ EOF çŠ¶æ€æ ‡å¿—
  - æœ€åæ“ä½œè¿½è¸ªï¼ˆè¯»/å†™ï¼‰
  - åŸå­è‡ªæ—‹é”ï¼ˆåŸºäº `AtomicBool`ï¼‰ç”¨äºå¤šçº¿ç¨‹å®‰å…¨

- **é»˜è®¤ç¼“å†²é…ç½®**ï¼š
  - `stdin`ï¼šå…¨ç¼“å†²ï¼ˆ`BufferMode::Full`ï¼‰
  - `stdout`ï¼šè¡Œç¼“å†²ï¼ˆ`BufferMode::Line`ï¼‰- é‡åˆ° `\n` è‡ªåŠ¨åˆ·æ–°
  - `stderr`ï¼šæ— ç¼“å†²ï¼ˆ`BufferMode::Unbuffered`ï¼‰- ç«‹å³è¾“å‡ºé”™è¯¯

### 2. **fflush() æ­£ç¡®è¯­ä¹‰** âœ…
- çœŸæ­£åˆ·æ–°å†™ç¼“å†²åŒºåˆ°ç³»ç»Ÿè°ƒç”¨
- `fflush(NULL)` åˆ·æ–°æ‰€æœ‰æ‰“å¼€çš„æµï¼ˆ`stdout` å’Œ `stderr`ï¼‰
- æ­£ç¡®å¤„ç†é”™è¯¯å¹¶è®¾ç½® errno

### 3. **å¢å¼ºçš„ printf æ ¼å¼åŒ–** âœ…

#### æ”¯æŒçš„æ ¼å¼è¯´æ˜ç¬¦ï¼š
| è¯´æ˜ç¬¦ | æè¿° | ç¤ºä¾‹ |
|--------|------|------|
| `%d`, `%i` | æœ‰ç¬¦å·åè¿›åˆ¶æ•´æ•° | `printf("%d", -42)` â†’ `-42` |
| `%u` | æ— ç¬¦å·åè¿›åˆ¶æ•´æ•° | `printf("%u", 4294967295)` â†’ `4294967295` |
| `%x`, `%X` | åå…­è¿›åˆ¶ï¼ˆå°å†™/å¤§å†™ï¼‰ | `printf("%x", 255)` â†’ `ff` |
| `%o` | å…«è¿›åˆ¶ | `printf("%o", 64)` â†’ `100` |
| `%p` | æŒ‡é’ˆ | `printf("%p", ptr)` â†’ `0x12345678` |
| `%c` | å­—ç¬¦ | `printf("%c", 'A')` â†’ `A` |
| `%s` | å­—ç¬¦ä¸² | `printf("%s", "hello")` â†’ `hello` |
| `%f`, `%F` | æµ®ç‚¹æ•° | `printf("%f", 3.14)` â†’ `3.140000` |
| `%%` | å­—é¢é‡ % | `printf("100%%")` â†’ `100%` |

#### æ”¯æŒçš„æ ‡å¿—ï¼š
| æ ‡å¿— | æè¿° | ç¤ºä¾‹ |
|------|------|------|
| `-` | å·¦å¯¹é½ | `printf("%-10d", 42)` â†’ `42        ` |
| `+` | æ€»æ˜¯æ˜¾ç¤ºç¬¦å· | `printf("%+d", 42)` â†’ `+42` |
| ` ` (ç©ºæ ¼) | æ­£æ•°å‰åŠ ç©ºæ ¼ | `printf("% d", 42)` â†’ ` 42` |
| `#` | å¤‡ç”¨å½¢å¼ | `printf("%#x", 255)` â†’ `0xff` |
| `0` | é›¶å¡«å…… | `printf("%05d", 42)` â†’ `00042` |

#### å®½åº¦å’Œç²¾åº¦ï¼š
- **å®½åº¦**ï¼š`%10d`ï¼ˆæœ€å°å­—æ®µå®½åº¦ï¼‰æˆ– `%*d`ï¼ˆåŠ¨æ€å®½åº¦ï¼‰
- **ç²¾åº¦**ï¼š`%.5d`ï¼ˆæ•´æ•°æœ€å°ä½æ•°ï¼‰ã€`%.2f`ï¼ˆæµ®ç‚¹å°æ•°ä½ï¼‰ã€`%.5s`ï¼ˆå­—ç¬¦ä¸²æœ€å¤§å­—ç¬¦ï¼‰

#### é•¿åº¦ä¿®é¥°ç¬¦ï¼š
| ä¿®é¥°ç¬¦ | ç±»å‹ | ç¤ºä¾‹ |
|--------|------|------|
| `hh` | char | `printf("%hhd", c)` |
| `h` | short | `printf("%hd", s)` |
| `l` | long | `printf("%ld", l)` |
| `ll` | long long | `printf("%lld", ll)` |
| `z` | size_t | `printf("%zu", sz)` |
| `t` | ptrdiff_t | `printf("%td", pt)` |

### 4. **æµ®ç‚¹æ•°æ”¯æŒ** âœ…
- å®ç°äº† `%f` å’Œ `%F` æµ®ç‚¹æ ¼å¼åŒ–
- æ”¯æŒç²¾åº¦æ§åˆ¶ï¼ˆé»˜è®¤ 6 ä½å°æ•°ï¼‰
- æ­£ç¡®å¤„ç† NaNã€Infinity å’Œè´Ÿé›¶
- ä½¿ç”¨æ•´æ•°ç¼©æ”¾è¿›è¡Œå¯é¢„æµ‹çš„èˆå…¥
- æ”¯æŒç¬¦å·æ ‡å¿—ï¼ˆ`+`, ` `ï¼‰å’Œå®½åº¦å¯¹é½

### 5. **é”™è¯¯å¤„ç†æ”¹è¿›** âœ…
- ä¸€è‡´çš„ errno è®¾ç½®
- åŒºåˆ† EOF å’Œé”™è¯¯æ¡ä»¶
- æ¯ä¸ªæµçš„é”™è¯¯çŠ¶æ€è¿½è¸ª
- `fwrite` å’Œ `fread` ä¸­çš„å¥å£®è¾¹ç•Œæ£€æŸ¥
- æº¢å‡ºæ£€æŸ¥ï¼ˆ`size * nmemb`ï¼‰

### 6. **çº¿ç¨‹å®‰å…¨** âœ…
- æ¯ä¸ª `FILE` çš„è½»é‡çº§è‡ªæ—‹é”
- é€šè¿‡ `FileGuard` RAII åŒ…è£…å™¨è‡ªåŠ¨é‡Šæ”¾é”
- é˜²æ­¢å¹¶å‘è®¿é—®ç›¸åŒæµæ—¶çš„æ•°æ®ç«äº‰
- åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸­å¼€é”€æœ€å°

### 7. **è¯»/å†™æ“ä½œæ”¹è¿›** âœ…
- è‡ªåŠ¨ç¼“å†²åŒºç®¡ç†
- è¯»/å†™æ¨¡å¼åˆ‡æ¢æ—¶æ­£ç¡®åˆ·æ–°
- å¤„ç†éƒ¨åˆ†è¯»/å†™
- æ”¯æŒå¤§äºç¼“å†²åŒºçš„ä¼ è¾“

## å®ç°ç»†èŠ‚

### no_std ç¯å¢ƒé€‚é…
ç”±äº NexaOS è¿è¡Œåœ¨ `no_std` ç¯å¢ƒä¸­ï¼Œéœ€è¦æ‰‹åŠ¨å®ç°ä¸€äº›æ ‡å‡†åº“å‡½æ•°ï¼š

```rust
fn trunc_f64(x: f64) -> f64 {
    if x >= 0.0 {
        (x as i64) as f64
    } else {
        -(((-x) as i64) as f64)
    }
}

fn round_f64(x: f64) -> f64 {
    let truncated = trunc_f64(x);
    let frac = x - truncated;
    if frac.abs() >= 0.5 {
        if x >= 0.0 { truncated + 1.0 } else { truncated - 1.0 }
    } else {
        truncated
    }
}

fn pow10(n: usize) -> u128 {
    let mut result = 1u128;
    for _ in 0..n {
        result *= 10;
    }
    result
}
```

### ç³»ç»Ÿè°ƒç”¨æ¥å£
```rust
#[inline(always)]
fn syscall3(n: u64, a1: u64, a2: u64, a3: u64) -> u64 {
    unsafe {
        asm!(
            "int 0x81",
            in("rax") n,
            in("rdi") a1,
            in("rsi") a2,
            in("rdx") a3,
            lateout("rax") ret,
            clobber_abi("sysv64"),
            options(nostack)
        );
    }
    ret
}
```

## æ€§èƒ½ä¼˜åŒ–

### å‡å°‘ç³»ç»Ÿè°ƒç”¨
- **ä¹‹å‰**ï¼šæ¯ä¸ª `putchar`/`puts` è°ƒç”¨éƒ½è§¦å‘ä¸€ä¸ª `sys_write`
- **ç°åœ¨**ï¼š
  - `stdout`ï¼šç¼“å†²ç›´åˆ°é‡åˆ°æ¢è¡Œç¬¦æˆ–ç¼“å†²åŒºæ»¡ï¼ˆ512 å­—èŠ‚ï¼‰
  - `stdin`ï¼šé¢„è¯»å–æ•°æ®å—ï¼Œå‡å°‘ `sys_read` è°ƒç”¨
  - `stderr`ï¼šä¿æŒæ— ç¼“å†²ä»¥ç¡®ä¿é”™è¯¯ç«‹å³å¯è§

### ç¤ºä¾‹æ€§èƒ½æ”¹è¿›
```c
// ä¹‹å‰ï¼š100 æ¬¡ç³»ç»Ÿè°ƒç”¨
for (int i = 0; i < 100; i++) {
    putchar('x');
}

// ç°åœ¨ï¼šçº¦ 1 æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼ˆæ‰€æœ‰å­—ç¬¦åœ¨ç¼“å†²åŒºä¸­ï¼‰
for (int i = 0; i < 100; i++) {
    putchar('x');
}
fflush(stdout);  // å•æ¬¡åˆ·æ–°
```

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬æ ¼å¼åŒ–
```c
printf("Hello %s!\n", "World");                    // Hello World!
printf("Number: %d\n", 42);                        // Number: 42
printf("Hex: 0x%x\n", 255);                        // Hex: 0xff
printf("Pointer: %p\n", ptr);                      // Pointer: 0x12345678
```

### å®½åº¦å’Œå¯¹é½
```c
printf("|%10d|\n", 42);                            // |        42|
printf("|%-10d|\n", 42);                           // |42        |
printf("|%010d|\n", 42);                           // |0000000042|
```

### ç²¾åº¦æ§åˆ¶
```c
printf("%.5d\n", 42);                              // 00042
printf("%.2f\n", 3.14159);                         // 3.14
printf("%.5s\n", "Hello World");                   // Hello
```

### æµ®ç‚¹æ•°
```c
printf("%f\n", 3.14159);                           // 3.141590
printf("%.2f\n", 3.14159);                         // 3.14
printf("%+.2f\n", 3.14);                           // +3.14
printf("%10.2f\n", 3.14);                          // |      3.14|
```

### ç¼“å†²æ§åˆ¶
```c
printf("Buffered...");       // ä¸ä¼šç«‹å³æ˜¾ç¤º
fflush(stdout);              // ç°åœ¨åˆ·æ–°åˆ°å±å¹•

fprintf(stderr, "Error!");   // ç«‹å³æ˜¾ç¤ºï¼ˆæ— ç¼“å†²ï¼‰
```

## å…¼å®¹æ€§

### POSIX å…¼å®¹æ€§
å®ç°éµå¾ª POSIX æ ‡å‡†ï¼š
- âœ… æ ‡å‡† FILE æµï¼ˆstdinã€stdoutã€stderrï¼‰
- âœ… ç¼“å†²è¯­ä¹‰ï¼ˆå…¨ç¼“å†²ã€è¡Œç¼“å†²ã€æ— ç¼“å†²ï¼‰
- âœ… fflush() è¡Œä¸º
- âœ… printf ç³»åˆ—å‡½æ•°
- âœ… é”™è¯¯å¤„ç†ï¼ˆerrnoï¼‰

### Rust std::io æ”¯æŒå‡†å¤‡
å½“å‰å®ç°ä¸ºæ”¯æŒ Rust çš„ `std::io` ç‰¹æ€§æä¾›äº†åŸºç¡€ï¼š
- âœ… ç¼“å†²è¯»/å†™
- âœ… é”™è¯¯ä¼ æ’­
- âœ… EOF å¤„ç†
- ğŸ”„ éœ€è¦æ·»åŠ ï¼š`std::io::Read`ã€`std::io::Write` trait å®ç°

## æ„å»ºå’Œæµ‹è¯•

### ç¼–è¯‘
```bash
cd /home/hanxi-cat/dev/nexa-os
./scripts/build-all.sh
```

### è¿è¡Œ
```bash
./scripts/run-qemu.sh
```

### æµ‹è¯•ç¨‹åº
åˆ›å»º `userspace/stdio_test.rs` æµ‹è¯•æ‰€æœ‰æ–°åŠŸèƒ½ï¼š
```bash
cd build/userspace-build
cargo rustc --release --bin stdio_test -- \
    --target ../../x86_64-nexaos-userspace.json \
    -C relocation-model=static \
    -C link-arg=-nostartfiles
```

## å·²çŸ¥é™åˆ¶

1. **å•çº¿ç¨‹ä¼˜åŒ–**ï¼šè™½ç„¶æœ‰é”æ”¯æŒï¼Œä½†é’ˆå¯¹å•çº¿ç¨‹ç¯å¢ƒä¼˜åŒ–
2. **å›ºå®šç¼“å†²åŒº**ï¼š512 å­—èŠ‚ç¼“å†²åŒºï¼ˆå¯è°ƒæ•´ `BUFFER_CAPACITY`ï¼‰
3. **æµ®ç‚¹ç²¾åº¦**ï¼šé™åˆ¶ä¸º 18 ä½å°æ•°ï¼ˆ`MAX_FLOAT_PRECISION`ï¼‰
4. **no_std é™åˆ¶**ï¼š
   - æ²¡æœ‰å †åˆ†é…ï¼ˆæ ˆåˆ†é…ç¼“å†²åŒºï¼‰
   - æ‰‹åŠ¨å®ç°æ•°å­¦å‡½æ•°ï¼ˆtruncã€roundï¼‰
   - é™æ€æ–‡ä»¶è¡¨ï¼ˆstdin/stdout/stderrï¼‰

## æœªæ¥æ”¹è¿›

1. **åŠ¨æ€æ–‡ä»¶æµ**ï¼šæ”¯æŒ `fopen()`ã€`fclose()` åˆ›å»ºæ–°æ–‡ä»¶æµ
2. **setvbuf()**ï¼šå…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºæ›´æ”¹ç¼“å†²æ¨¡å¼
3. **scanf() ç³»åˆ—**ï¼šå®ç°æ ¼å¼åŒ–è¾“å…¥
4. **æ‰©å±•æ ¼å¼**ï¼š
   - ç§‘å­¦è®¡æ•°æ³•ï¼ˆ`%e`, `%E`, `%g`, `%G`ï¼‰
   - æ›´å¤šé•¿åº¦ä¿®é¥°ç¬¦ï¼ˆ`L` ç”¨äº long doubleï¼‰
5. **æ€§èƒ½**ï¼š
   - ä½¿ç”¨æ›´å¤§çš„ç¼“å†²åŒºé€‰é¡¹
   - SIMD ä¼˜åŒ–çš„æ•´æ•°æ ¼å¼åŒ–
6. **Rust std::io**ï¼šå®Œæ•´çš„ trait å®ç°ä»¥æ”¯æŒ Rust æ ‡å‡†åº“

## æŠ€æœ¯å€ºåŠ¡ä¿®å¤

âœ… ä¿®å¤äº†æ‰€æœ‰ç¼–è¯‘é”™è¯¯ï¼š
- `VaListImpl::arg()` éœ€è¦ unsafe å—
- `f64::round()` å’Œ `f64::trunc()` åœ¨ no_std ä¸­ä¸å¯ç”¨
- ç±»å‹å‘½åçº¦å®šè­¦å‘Šï¼ˆ`PthreadDestructor`ï¼‰
- æœªä½¿ç”¨å˜é‡è­¦å‘Š

## æ€»ç»“

è¿™æ¬¡æ”¹è¿›å°† nrlib çš„ stdio å®ç°ä»ç©å…·çº§åˆ«æå‡åˆ°ç”Ÿäº§çº§åˆ«ï¼Œå®ç°äº†ï¼š
- ğŸš€ **æ›´å¥½çš„æ€§èƒ½**ï¼šé€šè¿‡ç¼“å†²å‡å°‘ç³»ç»Ÿè°ƒç”¨
- ğŸ“Š **å®Œæ•´åŠŸèƒ½**ï¼šprintf æ”¯æŒå®½åº¦ã€ç²¾åº¦ã€æ ‡å¿—å’Œæµ®ç‚¹æ•°
- ğŸ”’ **çº¿ç¨‹å®‰å…¨**ï¼šåŸºæœ¬çš„é”æ”¯æŒå¤šçº¿ç¨‹ç¨‹åº
- âœ… **POSIX å…¼å®¹**ï¼šéµå¾ªæ ‡å‡† libc è¡Œä¸º
- ğŸ¯ **ç”Ÿäº§å°±ç»ª**ï¼šå¥å£®çš„é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæ£€æŸ¥

ç°åœ¨ NexaOS ç”¨æˆ·ç©ºé—´ç¨‹åºå¯ä»¥äº«å—ç±»ä¼¼æ ‡å‡† C åº“çš„ I/O åŠŸèƒ½ï¼
