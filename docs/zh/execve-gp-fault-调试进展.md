# execve GP Fault è°ƒè¯•è¿›å±•

## å½“å‰çŠ¶æ€

å·²æ·»åŠ è¯¦ç»†çš„ä¸²å£è°ƒè¯•æ—¥å¿—åˆ° `syscall_execve`ï¼Œå¹¶ç®€åŒ–äº† shell çš„é”™è¯¯å¤„ç†é€»è¾‘ã€‚

## ä¿®æ”¹å†…å®¹

### 1. å†…æ ¸ï¼šæ·»åŠ ä¸²å£è°ƒè¯•æ—¥å¿—

åœ¨ `src/syscall.rs` çš„ `syscall_execve()` å‡½æ•°ä¸­æ·»åŠ äº†ç›´æ¥ä¸²å£è¾“å‡ºï¼š

```rust
crate::serial::_print(format_args!("[syscall_execve] Called\n"));
crate::serial::_print(format_args!("[syscall_execve] Path: {}\n", path_str));
crate::serial::_print(format_args!("[syscall_execve] Found file, {} bytes\n", data.len()));
crate::serial::_print(format_args!("[syscall_execve] Successfully loaded ELF, entry={:#x}, stack={:#x}\n", ...));
```

### 2. Shellï¼šç®€åŒ–é”™è¯¯å¤„ç†

ä¿®æ”¹ `userspace/shell.rs` ä¸­ `execute_external_command()` çš„å­è¿›ç¨‹é”™è¯¯å¤„ç†ï¼š

**ä¹‹å‰**ï¼š
```rust
if pid == 0 {
    let result = execve(...);
    print_str("execve failed with code: ");
    print_i32(result);   // å¯èƒ½åœ¨è¿™é‡Œå´©æºƒ
    println_str("");
    print_str("errno: ");
    print_i32(errno());  // æˆ–è¿™é‡Œ
    println_str("");
    exit(1);
}
```

**ç°åœ¨**ï¼š
```rust
if pid == 0 {
    let result = execve(...);
    if result < 0 {
        let msg = b"execve failed\n";
        write(2, msg.as_ptr(), msg.len());  // ç›´æ¥å†™stderrï¼Œé¿å…å¤æ‚æ‰“å°
    }
    syscall1(SYS_EXIT, 1);  // ç›´æ¥ç³»ç»Ÿè°ƒç”¨ï¼Œä¸ç»è¿‡åŒ…è£…å‡½æ•°
    loop { core::hint::spin_loop(); }  // å¦‚æœexitå¤±è´¥ï¼Œæ— é™å¾ªç¯
}
```

## é—®é¢˜åˆ†æ

### è§‚å¯Ÿåˆ°çš„ç°è±¡

ä»ç”¨æˆ·æä¾›çš„è¾“å‡ºï¼š

```
root@nexa:/$ nslookup
execve failed with code: -GP 0000000000000000 ...
```

å…³é”®å‘ç°ï¼š
1. âŒ æ²¡æœ‰çœ‹åˆ° `[syscall_execve]` çš„å†…æ ¸æ—¥å¿—ï¼ˆå³ä½¿ä¹‹å‰æ·»åŠ äº† kinfo!ï¼‰
2. âœ… èƒ½çœ‹åˆ°å…¶ä»–è¿›ç¨‹çš„ `[get_exec_context]` æ—¥å¿—ï¼ˆgetty, login, shellï¼‰
3. âš ï¸ shell è¾“å‡º "execve failed with code: -" åç«‹å³ GP fault
4. âš ï¸ `print_i32(result)` å¯èƒ½æ²¡æœ‰å®Œæˆå°±å´©æºƒäº†

### æ¨æµ‹çš„åŸå› 

**ä¸»è¦æ€€ç–‘ï¼šexecve éƒ¨åˆ†ç ´åäº†è¿›ç¨‹çŠ¶æ€**

1. `execve` ç³»ç»Ÿè°ƒç”¨è¢«è§¦å‘
2. å†…æ ¸å¼€å§‹æ›¿æ¢è¿›ç¨‹æ˜ åƒï¼ˆä¿®æ”¹ entry_point, stack_top, context ç­‰ï¼‰
3. æŸä¸ªæ­¥éª¤å¤±è´¥ï¼Œè¿”å› u64::MAXï¼ˆ-1ï¼‰
4. ä½†è¿›ç¨‹çŠ¶æ€å·²ç»è¢«éƒ¨åˆ†ä¿®æ”¹ï¼ˆæ ˆã€é¡µè¡¨ã€å¯„å­˜å™¨ç­‰ï¼‰
5. å­è¿›ç¨‹å°è¯•ç»§ç»­æ‰§è¡Œï¼ˆæ‰“å°é”™è¯¯ï¼‰ï¼Œä½†è¿è¡Œåœ¨æŸåçš„çŠ¶æ€ä¸­
6. å¯¼è‡´ GP faultï¼ˆRIP=0ï¼‰

**æ¬¡è¦æ€€ç–‘ï¼šæ‰“å°å‡½æ•°è®¿é—®æ— æ•ˆå†…å­˜**

å³ä½¿ execve æ­£ç¡®è¿”å›ï¼Œ`print_i32()` å¯èƒ½è®¿é—®äº†è¢«ç ´åçš„æ ˆæˆ–å…¨å±€æ•°æ®ã€‚

## ä¸‹ä¸€æ­¥è°ƒè¯•

### ç«‹å³è¡ŒåŠ¨

1. **è¿è¡Œæ–°æ„å»ºçš„ç³»ç»Ÿ**ï¼š
   ```bash
   ./scripts/run-qemu.sh
   ```

2. **æ‰§è¡Œ nslookup**ï¼š
   ```bash
   root@nexa:/$ nslookup
   ```

3. **æ£€æŸ¥ä¸²å£è¾“å‡º**ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
   ```
   [syscall_execve] Called
   [syscall_execve] Path: /bin/nslookup
   [syscall_execve] Found file, XXXXX bytes
   ```
   
   å¦‚æœçœ‹åˆ°è¿™äº›æ—¥å¿—ï¼Œç»§ç»­å¾€ä¸‹çœ‹ï¼š
   - å¦‚æœçœ‹åˆ° "Successfully loaded ELF" â†’ ELF åŠ è½½æˆåŠŸï¼Œé—®é¢˜åœ¨è¿›ç¨‹æ›¿æ¢
   - å¦‚æœçœ‹åˆ° "Error loading ELF" â†’ ELF åŠ è½½å¤±è´¥ï¼Œæ£€æŸ¥æ–‡ä»¶æ ¼å¼
   - å¦‚æœçœ‹åˆ° "file not found" â†’ è·¯å¾„æˆ–æ–‡ä»¶ç³»ç»Ÿé—®é¢˜

4. **å¯¹æ¯”æˆåŠŸçš„è¿›ç¨‹**ï¼š
   - Gettyã€loginã€shell éƒ½æˆåŠŸæ‰§è¡Œäº†ï¼ˆçœ‹åˆ° `[get_exec_context]` è¾“å‡ºï¼‰
   - å®ƒä»¬éƒ½æ˜¯é€šè¿‡ `Process::from_elf()` åŠ è½½çš„
   - ä½†å®ƒä»¬æ˜¯æ–°è¿›ç¨‹ï¼Œä¸æ˜¯é€šè¿‡ execve æ›¿æ¢çš„

### å¯èƒ½çš„ä¿®å¤æ–¹å‘

#### æ–¹æ¡ˆ Aï¼šä¿®å¤è¿›ç¨‹æ›¿æ¢é€»è¾‘

æ£€æŸ¥ `syscall_execve` ä¸­çš„è¿›ç¨‹æ›¿æ¢ä»£ç ï¼š

```rust
// åœ¨ src/syscall.rs çš„ syscall_execve ä¸­
entry.process.entry_point = new_process.entry_point;
entry.process.stack_top = new_process.stack_top;
entry.process.heap_start = new_process.heap_start;
entry.process.heap_end = new_process.heap_end;
entry.process.context = new_process.context;  // â† è¿™é‡Œå¯èƒ½æœ‰é—®é¢˜
entry.process.has_entered_user = false;
```

å¯èƒ½éœ€è¦ï¼š
- ä¿å­˜/æ¢å¤æ–‡ä»¶æè¿°ç¬¦è¡¨
- åˆ·æ–° TLB
- é‡ç½®æ›´å¤šè¿›ç¨‹çŠ¶æ€
- æ¸…ç†æ—§çš„å†…å­˜æ˜ å°„

#### æ–¹æ¡ˆ Bï¼šä½¿ç”¨ fork + å…¨æ–°è¿›ç¨‹

ä¸æ›¿æ¢è¿›ç¨‹ï¼Œè€Œæ˜¯ï¼š
1. å­è¿›ç¨‹åœ¨ fork åå®Œå…¨æ¸…ç©ºçŠ¶æ€
2. åŠ è½½æ–°çš„ ELF ä¸ºå…¨æ–°è¿›ç¨‹
3. è·³è½¬åˆ°æ–°çš„å…¥å£ç‚¹

#### æ–¹æ¡ˆ Cï¼šæ£€æŸ¥ nslookup äºŒè¿›åˆ¶

```bash
# æ£€æŸ¥ nslookup æ˜¯å¦æ˜¯æœ‰æ•ˆçš„ ELF
file build/rootfs/bin/nslookup

# æ£€æŸ¥æ˜¯å¦éœ€è¦åŠ¨æ€é“¾æ¥å™¨
readelf -l build/rootfs/bin/nslookup | grep INTERP

# æ£€æŸ¥å…¥å£ç‚¹
readelf -h build/rootfs/bin/nslookup | grep Entry
```

## æœŸæœ›çš„è¾“å‡º

### æˆåŠŸæƒ…å†µ

```
root@nexa:/$ nslookup google.com
[syscall_execve] Called
[syscall_execve] Path: /bin/nslookup
[syscall_execve] Found file, 146432 bytes
[syscall_execve] Successfully loaded ELF, entry=0x4xxxxx, stack=0x9ffee8
[get_exec_context] returning entry=0x4xxxxx, stack=0x9ffee8

Usage: nslookup <domain>
Example: nslookup google.com

root@nexa:/$
```

### å¤±è´¥æƒ…å†µï¼ˆæ–‡ä»¶ä¸å­˜åœ¨ï¼‰

```
root@nexa:/$ nslookup
[syscall_execve] Called
[syscall_execve] Path: /bin/nslookup
[syscall_execve] Error: file not found: /bin/nslookup
execve failed
root@nexa:/$
```

### å¤±è´¥æƒ…å†µï¼ˆELF æŸåï¼‰

```
root@nexa:/$ nslookup
[syscall_execve] Called
[syscall_execve] Path: /bin/nslookup
[syscall_execve] Found file, 146432 bytes
[syscall_execve] Error loading ELF: Invalid ELF magic
execve failed
root@nexa:/$
```

## å…³é”®ä»£ç ä½ç½®

- `src/syscall.rs::syscall_execve()` - è¡Œ 1413-1540
- `src/syscall.rs::get_exec_context()` - è¡Œ 38-60
- `src/process.rs::Process::from_elf()` - è¡Œ 133-250
- `userspace/shell.rs::execute_external_command()` - è¡Œ 1497-1595

## æµ‹è¯•å‘½ä»¤

```bash
# æ„å»ºç³»ç»Ÿ
./scripts/build-all.sh

# è¿è¡Œ QEMU
./scripts/run-qemu.sh

# åœ¨ shell ä¸­æµ‹è¯•
ls /bin                    # ç¡®è®¤ nslookup å­˜åœ¨
nslookup                   # è§¦å‘ bug
nslookup google.com        # å¸¦å‚æ•°æµ‹è¯•ï¼ˆå¦‚æœç¬¬ä¸€ä¸ªæˆåŠŸï¼‰
```

---

**çŠ¶æ€**: ğŸ”„ ç­‰å¾…æµ‹è¯•ç»“æœ  
**ä¼˜å…ˆçº§**: P0 (é˜»å¡åŸºæœ¬åŠŸèƒ½)  
**ä¸‹æ¬¡æ›´æ–°**: åˆ†æä¸²å£æ—¥å¿—å
