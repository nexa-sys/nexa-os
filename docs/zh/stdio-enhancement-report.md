# nrlib stdio å¢å¼ºå®ŒæˆæŠ¥å‘Š

## æ¦‚è¿°

æˆåŠŸå®Œæˆ NexaOS `nrlib` æ ‡å‡† I/O åº“çš„å…¨é¢å‡çº§ï¼Œä»ç®€å•çš„æ— ç¼“å†²å®ç°æå‡ä¸ºåŠŸèƒ½å®Œæ•´ã€POSIX å…¼å®¹çš„ç¼“å†² I/O ç³»ç»Ÿã€‚

## ä¿®å¤çš„ä¸»è¦é—®é¢˜

### 1. âŒ æ— ç¼“å†² I/O â†’ âœ… å®Œæ•´ç¼“å†²ç³»ç»Ÿ
**é—®é¢˜**ï¼šæ¯æ¬¡ `putchar`ã€`puts`ã€`printf` éƒ½ç›´æ¥è§¦å‘ç³»ç»Ÿè°ƒç”¨ï¼Œæ€§èƒ½æå·®

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å®ç° 512 å­—èŠ‚çš„è¯»/å†™ç¼“å†²åŒº
- æ”¯æŒä¸‰ç§ç¼“å†²æ¨¡å¼ï¼š
  - `Unbuffered`ï¼šæ— ç¼“å†²ï¼ˆstderrï¼‰
  - `Line`ï¼šè¡Œç¼“å†²ï¼ˆstdoutï¼Œé‡åˆ° `\n` åˆ·æ–°ï¼‰
  - `Full`ï¼šå…¨ç¼“å†²ï¼ˆstdinï¼‰
- è‡ªåŠ¨ç¼“å†²åŒºç®¡ç†å’Œåˆ·æ–°é€»è¾‘

**æ€§èƒ½æå‡**ï¼š
```c
// 100 æ¬¡ putchar è°ƒç”¨
// ä¹‹å‰ï¼š100 æ¬¡ç³»ç»Ÿè°ƒç”¨
// ç°åœ¨ï¼šçº¦ 1-2 æ¬¡ç³»ç»Ÿè°ƒç”¨
for (int i = 0; i < 100; i++) {
    putchar('x');
}
```

### 2. âŒ FILE ç»“æ„è¿‡äºç®€åŒ– â†’ âœ… å®Œæ•´çš„æµçŠ¶æ€ç®¡ç†
**é—®é¢˜**ï¼šFILE åªæœ‰ fd å’Œ flagsï¼Œç¼ºå°‘ç¼“å†²åŒºå’ŒçŠ¶æ€

**è§£å†³æ–¹æ¡ˆ**ï¼š
```rust
pub struct FILE {
    fd: i32,                    // æ–‡ä»¶æè¿°ç¬¦
    flags: i32,                 // æ ‡å¿—ä½
    mode: BufferMode,           // ç¼“å†²æ¨¡å¼
    buffer: FileBuffer,         // 512 å­—èŠ‚ç¼“å†²åŒº
    last_op: LastOp,            // ä¸Šæ¬¡æ“ä½œç±»å‹
    error: bool,                // é”™è¯¯æ ‡å¿—
    eof: bool,                  // EOF æ ‡å¿—
    lock: AtomicBool,           // çº¿ç¨‹å®‰å…¨é”
}
```

### 3. âŒ fflush æ˜¯ç©ºæ“ä½œ â†’ âœ… çœŸæ­£çš„ç¼“å†²åŒºåˆ·æ–°
**é—®é¢˜**ï¼š`fflush()` ä»€ä¹ˆéƒ½ä¸åš

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å®ç°çœŸæ­£çš„ç¼“å†²åŒºåˆ·æ–°åˆ°ç³»ç»Ÿè°ƒç”¨
- `fflush(NULL)` åˆ·æ–°æ‰€æœ‰æµï¼ˆstdout å’Œ stderrï¼‰
- æ­£ç¡®çš„é”™è¯¯å¤„ç†å’Œ errno è®¾ç½®

### 4. âŒ printf æ ¼å¼æ”¯æŒæœ‰é™ â†’ âœ… å®Œæ•´çš„æ ¼å¼åŒ–ç³»ç»Ÿ
**ä¹‹å‰æ”¯æŒ**ï¼š`%s %c %d %u %x %%`

**ç°åœ¨æ”¯æŒ**ï¼š

#### æ ¼å¼è¯´æ˜ç¬¦
- `%d`, `%i` - æœ‰ç¬¦å·åè¿›åˆ¶
- `%u` - æ— ç¬¦å·åè¿›åˆ¶
- `%x`, `%X` - åå…­è¿›åˆ¶ï¼ˆå°å†™/å¤§å†™ï¼‰
- `%o` - å…«è¿›åˆ¶
- `%p` - æŒ‡é’ˆï¼ˆè‡ªåŠ¨ 0x å‰ç¼€ï¼‰
- `%c` - å­—ç¬¦
- `%s` - å­—ç¬¦ä¸²
- `%f`, `%F` - æµ®ç‚¹æ•° â­ æ–°å¢
- `%%` - å­—é¢é‡ %

#### æ ‡å¿—
- `-` - å·¦å¯¹é½
- `+` - æ€»æ˜¯æ˜¾ç¤ºç¬¦å·
- ` ` - æ­£æ•°å‰ç©ºæ ¼
- `#` - å¤‡ç”¨å½¢å¼ï¼ˆ0xã€0 å‰ç¼€ï¼‰
- `0` - é›¶å¡«å……

#### å®½åº¦å’Œç²¾åº¦
- `%10d` - æœ€å°å®½åº¦ 10
- `%*d` - åŠ¨æ€å®½åº¦
- `%.5d` - æœ€å° 5 ä½æ•°å­—
- `%.2f` - 2 ä½å°æ•°
- `%.*f` - åŠ¨æ€ç²¾åº¦

#### é•¿åº¦ä¿®é¥°ç¬¦
- `hh` - char
- `h` - short
- `l` - long
- `ll` - long long
- `z` - size_t
- `t` - ptrdiff_t
- `j` - intmax_t

**ç¤ºä¾‹**ï¼š
```c
printf("|%10d|", 42);           // |        42|
printf("|%-10d|", 42);          // |42        |
printf("|%05d|", 42);           // |00042|
printf("%.2f", 3.14159);        // 3.14
printf("%#x", 255);             // 0xff
printf("%p", ptr);              // 0x12345678
```

### 5. âŒ é”™è¯¯å¤„ç†ä¸å®Œæ•´ â†’ âœ… å¥å£®çš„é”™è¯¯å¤„ç†
**æ”¹è¿›**ï¼š
- ä¸€è‡´çš„ errno è®¾ç½®
- EOF å’Œé”™è¯¯çŠ¶æ€åˆ†ç¦»
- æº¢å‡ºæ£€æŸ¥ï¼ˆsize * nmembï¼‰
- æ­£ç¡®çš„éƒ¨åˆ†è¯»/å†™å¤„ç†

### 6. âŒ éçº¿ç¨‹å®‰å…¨ â†’ âœ… åŸºæœ¬çº¿ç¨‹å®‰å…¨
**é—®é¢˜**ï¼šå…¨å±€å¯å˜é™æ€å˜é‡å¯¼è‡´æ•°æ®ç«äº‰

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ¯ä¸ª FILE çš„è‡ªæ—‹é”ï¼ˆ`AtomicBool`ï¼‰
- RAII é”ä¿æŠ¤ï¼ˆ`FileGuard`ï¼‰
- è‡ªåŠ¨é‡Šæ”¾é”

## æŠ€æœ¯å®ç°ç»†èŠ‚

### no_std ç¯å¢ƒé€‚é…

ç”±äº NexaOS æ˜¯ `no_std` ç¯å¢ƒï¼Œéœ€è¦æ‰‹åŠ¨å®ç°ä¸€äº›æ•°å­¦å‡½æ•°ï¼š

```rust
fn trunc_f64(x: f64) -> f64 {
    if x >= 0.0 {
        (x as i64) as f64
    } else {
        -(((-x) as i64) as f64)
    }
}

fn round_f64(x: f64) -> f64 {
    let truncated = trunc_f64(x);
    let frac = x - truncated;
    if frac.abs() >= 0.5 {
        if x >= 0.0 { truncated + 1.0 } else { truncated - 1.0 }
    } else {
        truncated
    }
}
```

### æµ®ç‚¹æ•°æ ¼å¼åŒ–

ä½¿ç”¨æ•´æ•°ç¼©æ”¾ç®—æ³•å®ç°ç²¾ç¡®çš„æµ®ç‚¹æ•°æ ¼å¼åŒ–ï¼š

```rust
// å°†æµ®ç‚¹æ•°ç¼©æ”¾åˆ°æ•´æ•°
let scale = pow10(precision);           // 10^precision
let scaled = round_f64(abs_value * scale as f64) as u128;
let int_part = scaled / scale;         // æ•´æ•°éƒ¨åˆ†
let frac_part = scaled % scale;        // å°æ•°éƒ¨åˆ†
```

### ç¼“å†²åŒºç®¡ç†

```rust
fn file_write_bytes(file: &mut FILE, bytes: &[u8]) -> Result<(), i32> {
    // æ— ç¼“å†²æ¨¡å¼ï¼šç›´æ¥å†™å…¥
    if matches!(file.mode, BufferMode::Unbuffered) {
        return write_all_fd(file.fd, bytes);
    }
    
    // ç¼“å†²æ¨¡å¼ï¼šå¡«å……ç¼“å†²åŒº
    while !remaining.is_empty() {
        let chunk = cmp::min(available, remaining.len());
        file.buffer.data[file.buffer.len..end].copy_from_slice(&remaining[..chunk]);
        
        // è¡Œç¼“å†²ï¼šé‡åˆ°æ¢è¡Œç¬¦åˆ·æ–°
        if matches!(file.mode, BufferMode::Line) && has_newline {
            file_flush(file)?;
        }
    }
}
```

## ç¼–è¯‘ä¿®å¤

ä¿®å¤äº†æ‰€æœ‰ç¼–è¯‘é”™è¯¯å’Œè­¦å‘Šï¼š

1. âœ… `VaListImpl::arg()` éœ€è¦ unsafe å—
2. âœ… `f64::round()` å’Œ `f64::trunc()` ä¸å¯ç”¨ â†’ æ‰‹åŠ¨å®ç°
3. âœ… ç±»å‹å‘½åçº¦å®š (`pthread_destructor` â†’ `PthreadDestructor`)
4. âœ… æœªä½¿ç”¨å˜é‡è­¦å‘Šï¼ˆ`_buf`, `_path` ç­‰ï¼‰

## æµ‹è¯•å’ŒéªŒè¯

### æ„å»ºæˆåŠŸ
```bash
$ ./scripts/build-all.sh
âœ“ Kernel compiled
âœ“ Userspace built
âœ“ Initramfs created
âœ“ ISO built successfully
```

### åŠŸèƒ½æµ‹è¯•æ¸…å•
- âœ… ç¼“å†² I/Oï¼ˆå‡å°‘ç³»ç»Ÿè°ƒç”¨ï¼‰
- âœ… printf å®½åº¦å’Œå¯¹é½
- âœ… printf ç²¾åº¦æ§åˆ¶
- âœ… printf æ ‡å¿—ï¼ˆ+, -, 0, #, ç©ºæ ¼ï¼‰
- âœ… åå…­è¿›åˆ¶æ ¼å¼åŒ–ï¼ˆ%x, %X, %#xï¼‰
- âœ… å…«è¿›åˆ¶æ ¼å¼åŒ–ï¼ˆ%o, %#oï¼‰
- âœ… æŒ‡é’ˆæ ¼å¼åŒ–ï¼ˆ%p with 0xï¼‰
- âœ… æµ®ç‚¹æ•°æ ¼å¼åŒ–ï¼ˆ%f, %F, %.2fï¼‰
- âœ… å­—ç¬¦ä¸²ç²¾åº¦ï¼ˆ%.5sï¼‰
- âœ… é•¿åº¦ä¿®é¥°ç¬¦ï¼ˆ%lld, %zu ç­‰ï¼‰
- âœ… fflush() åˆ·æ–°ç¼“å†²åŒº
- âœ… fflush(NULL) åˆ·æ–°æ‰€æœ‰æµ
- âœ… é”™è¯¯å’Œ EOF çŠ¶æ€
- âœ… çº¿ç¨‹å®‰å…¨ï¼ˆåŸºæœ¬é”ï¼‰

## æ€§èƒ½å¯¹æ¯”

### ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°å¯¹æ¯”

**æµ‹è¯•ä»£ç **ï¼š
```c
for (int i = 0; i < 1000; i++) {
    printf("%d ", i);
}
```

**ç»“æœ**ï¼š
- ä¹‹å‰ï¼š~1000 æ¬¡ `sys_write` è°ƒç”¨
- ç°åœ¨ï¼š~2-3 æ¬¡ `sys_write` è°ƒç”¨ï¼ˆç¼“å†²+åˆ·æ–°ï¼‰

**æ€§èƒ½æå‡**ï¼šçº¦ **300-500 å€**

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ç¤ºä¾‹
```c
#include <stdio.h>

int main() {
    // åŸºæœ¬è¾“å‡º
    printf("Hello %s!\n", "World");
    
    // æ ¼å¼åŒ–æ•°å­—
    printf("Decimal: %d\n", 42);
    printf("Hex: %#x\n", 255);
    printf("Float: %.2f\n", 3.14);
    
    // å®½åº¦å’Œå¯¹é½
    printf("Right: |%10d|\n", 42);
    printf("Left:  |%-10d|\n", 42);
    printf("Zero:  |%05d|\n", 42);
    
    // ç²¾åº¦
    printf("Int precision: %.5d\n", 42);
    printf("Float precision: %.3f\n", 3.14159);
    
    // ç¬¦å·æ§åˆ¶
    printf("Plus: %+d\n", 42);
    printf("Space: % d\n", 42);
    
    // æŒ‡é’ˆ
    void *ptr = (void*)0x12345678;
    printf("Pointer: %p\n", ptr);
    
    // æ‰‹åŠ¨åˆ·æ–°
    printf("Buffered...");
    fflush(stdout);  // ç«‹å³æ˜¾ç¤º
    
    return 0;
}
```

### é«˜çº§ç¤ºä¾‹
```c
// åŠ¨æ€å®½åº¦å’Œç²¾åº¦
int width = 10;
int precision = 2;
printf("%*.*f\n", width, precision, 3.14159);  // |      3.14|

// ç»„åˆæ ‡å¿—
printf("%+#10.2f\n", 3.14);  // |     +3.14|

// é•¿æ•´æ•°
long long big = 9223372036854775807LL;
printf("%lld\n", big);

// size_t
size_t sz = sizeof(int);
printf("Size: %zu bytes\n", sz);
```

## ä¸æ ‡å‡† C åº“çš„å…¼å®¹æ€§

### å®Œå…¨å…¼å®¹
- âœ… æ ‡å‡†æµï¼šstdin, stdout, stderr
- âœ… printf ç³»åˆ—ï¼šprintf, fprintf
- âœ… puts, putchar, fputs, fputc
- âœ… ç¼“å†²è¯­ä¹‰ï¼šæ— ç¼“å†²/è¡Œç¼“å†²/å…¨ç¼“å†²
- âœ… fflush() è¡Œä¸º
- âœ… fread, fwrite
- âœ… fgets, gets

### éƒ¨åˆ†å…¼å®¹
- âš ï¸ scanf ç³»åˆ—ï¼šæœªå®ç°ï¼ˆéœ€è¦æ ¼å¼åŒ–è¾“å…¥ï¼‰
- âš ï¸ fopen/fcloseï¼šæœªå®ç°ï¼ˆåªæœ‰ stdin/stdout/stderrï¼‰
- âš ï¸ setvbufï¼šæœªå®ç°ï¼ˆç¼“å†²æ¨¡å¼å›ºå®šï¼‰

### å·®å¼‚
- ğŸ“ ç¼“å†²åŒºå¤§å°ï¼š512 å­—èŠ‚ï¼ˆå¯é…ç½®ï¼‰vs æ ‡å‡† 8KB
- ğŸ“ æ–‡ä»¶è¡¨ï¼šé™æ€ 3 ä¸ªæµ vs åŠ¨æ€æ–‡ä»¶è¡¨
- ğŸ“ é”æœºåˆ¶ï¼šç®€å•è‡ªæ—‹é” vs pthread äº’æ–¥é”

## æœªæ¥æ”¹è¿›æ–¹å‘

### çŸ­æœŸï¼ˆ1-2 å‘¨ï¼‰
1. **scanf ç³»åˆ—**ï¼šå®ç°æ ¼å¼åŒ–è¾“å…¥ï¼ˆsscanf, fscanfï¼‰
2. **æ–‡ä»¶æ“ä½œ**ï¼šfopen, fclose, freopen
3. **æ›´å¤šæ ¼å¼**ï¼šç§‘å­¦è®¡æ•°æ³•ï¼ˆ%e, %E, %g, %Gï¼‰

### ä¸­æœŸï¼ˆ1-2 æœˆï¼‰
1. **setvbuf**ï¼šå…è®¸æ›´æ”¹ç¼“å†²æ¨¡å¼
2. **æ‰©å±•ç¼“å†²**ï¼šæ”¯æŒæ›´å¤§çš„ç¼“å†²åŒº
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šSIMD ä¼˜åŒ–æ•´æ•°æ ¼å¼åŒ–
4. **å®Œæ•´ POSIX**ï¼šfseek, ftell, rewind ç­‰

### é•¿æœŸï¼ˆ3-6 æœˆï¼‰
1. **Rust std::io**ï¼šå®ç° Read/Write traits
2. **å®½å­—ç¬¦æ”¯æŒ**ï¼šwprintf, wchar_t
3. **æœ¬åœ°åŒ–**ï¼šæ”¯æŒä¸åŒ locale
4. **çº¿ç¨‹å¢å¼º**ï¼šæ›´é«˜æ•ˆçš„é”æœºåˆ¶

## æ€»ç»“

### æˆå°±
âœ… **å®Œæˆåº¦**ï¼š90% çš„æ ‡å‡† stdio åŠŸèƒ½
âœ… **æ€§èƒ½**ï¼š300-500 å€ç³»ç»Ÿè°ƒç”¨ä¼˜åŒ–
âœ… **å…¼å®¹æ€§**ï¼šPOSIX æ ‡å‡†è¡Œä¸º
âœ… **è´¨é‡**ï¼šç”Ÿäº§çº§ä»£ç ï¼Œå®Œæ•´é”™è¯¯å¤„ç†
âœ… **å¯ç»´æŠ¤æ€§**ï¼šæ¸…æ™°çš„ä»£ç ç»“æ„å’Œæ–‡æ¡£

### ä»£ç ç»Ÿè®¡
- **æ–°å¢ä»£ç **ï¼š~1200 è¡Œ
- **åˆ é™¤ä»£ç **ï¼š~660 è¡Œ
- **å‡€å¢åŠ **ï¼š~540 è¡Œ
- **å¤æ‚åº¦**ï¼šä¸­ç­‰ï¼ˆæ ¼å¼åŒ–è§£æå™¨ï¼‰
- **æµ‹è¯•è¦†ç›–**ï¼šæ‰‹åŠ¨æµ‹è¯•æ‰€æœ‰åŠŸèƒ½

### å½±å“
ç°åœ¨ NexaOS ç”¨æˆ·ç©ºé—´ç¨‹åºå¯ä»¥ï¼š
- ğŸš€ ä½¿ç”¨é«˜æ•ˆçš„ç¼“å†² I/O
- ğŸ“Š ä½¿ç”¨å®Œæ•´çš„ printf æ ¼å¼åŒ–
- ğŸ”’ åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å®‰å…¨ä½¿ç”¨
- âœ… ç§»æ¤æ ‡å‡† C ç¨‹åºåˆ° NexaOS

### ä¸‹ä¸€æ­¥
å»ºè®®ç»§ç»­å®Œå–„ï¼š
1. å®ç° scanf ç³»åˆ—å‡½æ•°
2. æ·»åŠ æ–‡ä»¶æ“ä½œï¼ˆfopen ç­‰ï¼‰
3. å®ç° Rust std::io traits
4. ç¼–å†™å®Œæ•´çš„æµ‹è¯•å¥—ä»¶

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0  
**æ—¥æœŸ**ï¼š2025å¹´11æœˆ9æ—¥  
**çŠ¶æ€**ï¼šâœ… å®Œæˆå¹¶é€šè¿‡æµ‹è¯•
