# NexaOS Kernel Modules Configuration
#
# This file defines all kernel modules, their properties, and build settings.
# Modules can be enabled/disabled per-profile in build.yaml or overridden here.
#
# Module Types:
#   1 = Filesystem driver
#   2 = Block device driver
#   3 = Character device driver
#   4 = Network driver
#   5 = Virtual device driver

# =============================================================================
# Filesystem Drivers
# =============================================================================
# Filesystem modules provide support for various on-disk formats.
# The ext family shares common code via ext_common.

filesystem:
  ext2:
    enabled: true
    type: 1
    description: "Second Extended Filesystem (ext2)"
    package: ext2
    output: ext2.nkm
    load_order: 10
    depends: []
    # ext2 is the base for ext3/ext4, should be loaded first if others need it
    provides:
      - ext2_fs
    config:
      # Maximum file size supported (bytes, 0 = unlimited)
      max_file_size: 0
      # Enable large file support (>2GB)
      large_file: true
  
  ext3:
    enabled: true
    type: 1
    description: "Third Extended Filesystem with journaling (ext3)"
    package: ext3
    output: ext3.nkm
    load_order: 11
    depends:
      - ext2
    provides:
      - ext3_fs
    config:
      # Journal size in MB (0 = auto)
      journal_size: 0
      # Journal mode: ordered, writeback, journal
      journal_mode: ordered
  
  ext4:
    enabled: true
    type: 1
    description: "Fourth Extended Filesystem with extents (ext4)"
    package: ext4
    output: ext4.nkm
    load_order: 12
    depends:
      - ext3
    provides:
      - ext4_fs
    config:
      # Enable extent trees (recommended)
      extents: true
      # Enable directory indexing
      dir_index: true
      # Enable 64-bit block numbers
      64bit: true

# =============================================================================
# Block Device Drivers
# =============================================================================
# Block device drivers provide access to storage devices.

block:
  virtio_blk:
    enabled: true
    type: 2
    description: "VirtIO Block Device Driver"
    package: virtio_blk
    output: virtio_blk.nkm
    load_order: 5
    depends: []
    provides:
      - virtio_blk
    config:
      # Maximum queue depth
      queue_depth: 128
      # Enable multi-queue support
      multi_queue: true
      # Block size (bytes)
      block_size: 512

# =============================================================================
# Memory Management Modules
# =============================================================================
# Modules that extend kernel memory management capabilities.

memory:
  swap:
    enabled: true
    type: 3
    description: "Swap Subsystem Driver"
    package: swap
    output: swap.nkm
    load_order: 3
    depends: []
    provides:
      - swap
    config:
      # Enable swap by default at boot
      auto_enable: false
      # Default swappiness (0-100, higher = more aggressive swapping)
      swappiness: 60
      # Maximum swap devices
      max_swap_devices: 8
      # Enable swap compression (future)
      compression: false
      # Compression algorithm (lz4, zstd)
      compression_algo: lz4

# =============================================================================
# Network Drivers
# =============================================================================
# Network interface card (NIC) drivers.

network:
  e1000:
    enabled: true
    type: 4
    description: "Intel E1000/E1000E Gigabit Ethernet Driver"
    package: e1000
    output: e1000.nkm
    load_order: 20
    depends: []
    provides:
      - e1000_nic
      - ethernet
    config:
      # RX ring buffer size
      rx_ring_size: 256
      # TX ring buffer size  
      tx_ring_size: 256
      # Enable hardware checksum offload
      hw_checksum: true
      # Enable interrupt coalescing
      interrupt_coalesce: true
      # Coalesce delay (microseconds)
      coalesce_usecs: 100
  
  virtio_net:
    enabled: false  # Not yet fully implemented
    type: 4
    description: "VirtIO Network Driver"
    package: virtio_net
    output: virtio_net.nkm
    load_order: 21
    depends: []
    provides:
      - virtio_net
      - ethernet
    config:
      # Number of virtqueues
      num_queues: 2
      # Enable checksum offload
      csum_offload: true
      # Enable TSO (TCP Segmentation Offload)
      tso: true

# =============================================================================
# Shared Module Dependencies
# =============================================================================
# Internal libraries shared between modules (not loadable modules themselves)

shared:
  ext_common:
    description: "Common code for ext2/3/4 filesystems"
    package: ext_common
    # This is compiled into ext modules, not a standalone .nkm
    type: library
  
  virtio_common:
    description: "Common VirtIO infrastructure"
    package: virtio_common
    type: library
  
  kmod_api:
    description: "Kernel Module API definitions"
    package: kmod_api
    type: library

# =============================================================================
# Module Loading Configuration
# =============================================================================
# Settings for automatic module loading at boot

autoload:
  # Modules to load during initramfs phase (before root pivot)
  initramfs:
    - virtio_blk  # Need block device access
    - ext2        # Need filesystem to mount root
  
  # Modules to load after root pivot
  rootfs:
    - e1000       # Network driver
    - swap        # Swap support (if enabled in profile)

# =============================================================================
# Module Signing
# =============================================================================
signing:
  # Require all modules to be signed
  required: true
  
  # Path to signing certificate
  certificate: certs/signing_key.x509
  
  # Path to signing key
  private_key: certs/signing_key.der
  
  # Signing algorithm
  algorithm: sha256
